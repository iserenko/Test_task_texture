# Test_task_texture
Репозиторий с решением тестового задания по созданию бесшовных текстур.

Время, потраченное на решение: 2 дня (3-4 часа в первый день на изучение существующих подходов и 7-8 часов во второй день на выбор, реализацию, тестирование)

# Входные данные
![Входное изображение текстуры ткани](/images/texture.png)

# Решение

Начнём с простого повторения изображения по схеме 3х3 без изменения ориентации тайлов и применения каких-либо методов обработки, чтобы оценить проблемы, которые предстоит решать.

![Простое повторение исходного тайла по схеме 3х3](/images/texture_repeated.png)

Текстура очевидно не является "бесшовной". Отчётливо видны повторяющиеся паттерны оригинальной текстуры, цветовые переходы и стыки на границах тайлов. Особенно выделяются: более тёмный верхний левый угол каждого тайла, вертикальные стыки между тайлами из-за переходв цвета, и горизонтальная линия сгиба ткани по центру.

## 1. Метод отражений
Попробуем метод отражений: в центре помещается исходный тайл, сверху и снизу от него - исходный тайл, отражённый по вертикали, слева и справа - исходный тайл, отражённый по горизонтали, по углам - исходный тайл, отражённый по вертикали и по горизонтали.

![Повторение исходного тайла методом отражений по схеме 3х3](/images/texture_mirrored.png)

Заметных цветовых переходов на границах тайлов больше нет, однако границы видны по образовавшимся зеркальным артефактам. Присутствуют очевидные повторяющиеся паттерны оригинальной текстуры.

## 2. Альфа-смешивание

Попробуем убрать швы между тайлами путём смешивания пограничных участков с использованием равномерно изменяющегося значения прозрачности (альфа-канала), который мы реализуем как пару масок для изображения.

Пошаговый алгоритм: 

 1. Определяем ширину полосы рядом с границей тайла, к которой будем применять преобразование (задаём разные значения ширины для горизонтальных, 'BORDER_WIDTH_PERCENT_HORZ', и вертикальных, 'BORDER_WIDTH_PERCENT_VERT', краёв, чтобы визуально улучшить результат)
 2. Обрабатываем сначала вертикальные швы. Создаём 2 новых изображения из исходного тайла, используя функцию 'np.roll()', чтобы вертикальная граница оказалась в центре тайла (для удобства). Один тайл сдвинут левее от центра, второй - правее на одно и то же значение пикселей 'border_size_vert', зависящее от заданного параметра.
 3. Создаём градиентную альфа-маску для плавного перехода в центре тайла (ширина градиента 2 * 'border_size_vert') и обратную ей маску
 4. Далее применяем маски к соответствующим двум новым тайлам из шага 2
 5. Складываем полученные изображения
 6. Делаем то же самое для горизонтальных швов
 7. Возвращаем обработанный тайл в исходное положение с помощью 'np.roll()' и повторяем по заданному шаблону 3 на 3

![Новая текстура в 3 раза больше входной](/images/resulting_texture.png)

Таким образом, мы избавились от заметных цветовых переходов и стыков на границах тайлов. Остались видны только горизонтальные линии сгиба ткани, присутствующие и на оригинальном изображении. При необходимости можно сгладить их тем же методом альфа-блендинга.

Основные плюсы решения:
1. Условия из задания соблюдены: результат выглядит как одна полная текстура большего размера, нет заметных цветовых переходов и стыков на границах тайлов, выделяющихся повторяющихся паттернов также нет (крроме линии сгиба ткани). 
2. Алгоритм не влияет на качество исходного тайла, так как не происходит сжатия и растяжения изображения, не применяются фильтры размытия. Разрешение при этом в 3 раза больше исходного.
3. Быстрый алгоритм за счёт использования в основном функций numpy

Основные минусы решения: 
1. Решение адаптировано под конкретную текстуру ткани с мелким плетением. В случае наличия более крупных различимых элементов текстуры метод альфа-блендинга не подойдёт
2. Обработанные стыки могут выглядеть менее резкими, чем остальное изображение. 

В качестве дальнейших шагов можно попробовать использовать фильтр GaussianBlur, чтобы выделить размытую составляющую и вычесть её из изображения. Однако применение фильтров ко всему изображению повлияет на резкость исходного тайла, а применеие фильтров только к обработанным участкам может сделать их ещё более заметными. 

Применение GaussianBlur и addWeighted к выходному изображению:
![GaussianBlur + addWeighted](/images/resulting_blur_addweighted.png)

Чтобы сгладить различия в резкости, также можно попробовать использовать фильтр размытия на всём изображении, а затем одну из моделей для решения задачи SuperResolution. В случае с исходной текстурой данный подход кажется неоправданно сложным.

Также можно использовать Stable Diffusion Inpainting для генерирования частей изображения в области стыков и создания бесшовной текстуры.

##  3. Готовые open-source решения 
Существуют также готовые решения для похожей задачи создания бесшовных текстур: 

1.   https://github.com/rtmigo/img2texture/tree/master - использует альфа-блендинг
2.   https://github.com/sagieppel/convert-image-into-seamless-tileable-texture - более сложный подход, учитывающий разницу между краями изображения при смешивании и использующий Gaussian blur для сглаживания переходов.
3. https://github.com/sagieppel/transform-image-into-seamless-tileable-texture-using-stable-diffusion-inpainting - использование StableDiffusion для преобразования краёв тайла с целью создания бесшовной текстуры
4. https://github.com/TheRealMAV/texture-synthesis/tree/main - генерирование новой текстуры желаемого размера на основе исходного тайла (случайным образом выбирается блок из исходного изображения, далее полсдеовательно подбираются наиболее подходящие блоки для вставки справа и снизу от выбранного блока)

 Результат применения готового решения 1
 ![ Результат применения готового решения 1](/images/existing_solution_1.png)

 Этот метод также основан на подходе альфа-блендинга, но он обрезает края изображения. Здесь используется для сравнения с результатом, полуенным в ходе решения.

  Результат применения готового решения 4
   ![ Результат применения готового решения 1](/images/existing_solution_2.png)

  Минусы: очень медленный алгоритм, заимствованный код требует рефакторинга и пояснений, также присутствуют blocking artifacts.
 
